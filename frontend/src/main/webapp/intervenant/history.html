<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Historique</title>
  <link rel="stylesheet" href="history.css" />
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
</head>

<body>
  <div class="navbar">
    <a href="demande.html">
      <button type="button" class="nav-button">Demande de cours</button>
    </a>
    <a href="history.html">
      <button type="button" class="nav-button active">Historique</button>
    </a>
    <a href="stats.html">
      <button type="button" class="nav-button">Statistiques</button>
    </a>
    <a href="profile.html">
      <button type="button" class="nav-button">Profil</button>
    </a>
    <button type="button" class="nav-button" onlclick="logout()">Déconnexion</button>
  </div>
  <h1>Historique de vos cours:</h1>
  <div class="history">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Matière</th>
          <th>Eleve</th>
          <th>Durée</th>
          <th>Bilan</th>
        </tr>
      </thead>
      <tbody id="historyTableBody">
        <!-- Les demandes seront insérées ici -->
      </tbody>
    </table>
  </div>
  <dialog id="bilan-dialog">
    <div class="container">
      <div class="header">
        <h1>Bilan</h1>
      </div>
      <div class="bilan-content">
        <p id="bilan-text"></p>
      </div>
      <div class="form-group">
        <button type="button" class="btn secondary" onclick="closeBilan()">Fermer</button>
      </div>
    </div>
  </dialog>
</body>
<script>
  $(document).ready(() => {
    $.ajax({
      url: '../ActionServlet',
      method: 'POST',
      data: { todo: 'my-history' },
      dataType: 'json'
    })
      .done(function (response) {
        const historyTableBody = $('#historyTableBody');
        response.forEach(function (demande) {
          const row = '<tr>' +
            '<td>' + new Date(demande.dateDebut).toLocaleDateString() + '</td>' +
            '<td>' + demande.matiere.denomination + '</td>' +
            '<td>' + demande.eleveDto.nom + ' ' + demande.eleveDto.prenom + '</td>' +
            '<td>' + formatDuration(demande.duree) + '</td>' +
            '<td><button type="button" class="btn secondary" onclick="showBilan(\'' + demande.bilan + '\')">Voir bilan</button></td>' +
            '</tr>';
          historyTableBody.append(row);

        });
      })
      .fail(function (error) {
        console.error('Erreur lors de la récupération de l\'historique des demandes:', error);
      });
  });

  // Fonction pour formater la durée en heures, minutes et secondes
  function formatDuration(duration) {
    const seconds = parseInt(duration, 10) % 60;
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    return hours + 'h' + (minutes < 10 ? '0' : '') + minutes + 'min' + (seconds < 10 ? '0' : '') + seconds + 's';
  }

  function showBilan(bilan) {
    const dialog = document.getElementById('bilan-dialog');
    const bilanText = document.getElementById('bilan-text');
    bilanText.textContent = bilan;
    dialog.showModal();
  }

  function closeBilan() {
    const dialog = document.getElementById('bilan-dialog');
    dialog.close();
  }

  function logout() {
    $.ajax({
      url: '../ActionServlet',
      method: 'POST',
      data: { todo: 'signout' },
      dataType: 'json'
    })
      .done((response) => {
        window.location.href = '../index.html';
      })
      .fail((error) => {
        console.error('Erreur lors de la déconnexion:', error);
      });
  }
</script>

</html>