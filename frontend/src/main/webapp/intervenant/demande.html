<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Demande</title>
  <link rel="stylesheet" href="demande.css" />
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
</head>

<body>
  <dialog id="visio-dialog" open="true">
    <div class="container">
      <div class="header">
        <h1>Visio</h1>
      </div>
      <div class="details-eleve">
        <h2>Visio avec : <span id="studentFullName">[NOM] [Prénom]</span></h2>
      </div>
      <div class="image-container">
        <img id="visio-img" src="../images/visio.png" alt="Image" />
      </div>
      <div class="form-group">
        <button type="button" class="btn" id="end-visio-button" onclick="endVisio()">Quitter la visio</button>
      </div>
      <div class="form-group">
        <textarea id="bilan" placeholder="Écrivez le bilan ici sur plusieurs lignes si besoin" oninput="checkBilan()"></textarea>
      </div>
      <div class="form-group">
        <button type="button" class="btn secondary" id="send-button" onclick="sendBilan()" disabled>Envoyer le bilan</button>
      </div>
    </div>
  </dialog>
  <div class="navbar">
    <a href="./demande.html">
      <button type="button" class="nav-button active">Demande de cours</button>
    </a>
    <a href="./history.html">
      <button type="button" class="nav-button">Historique</button>
    </a>
    <a href="stat.html">
      <button type="button" class="nav-button">Statistiques</button>
    </a>
    <a href="profile.html">
      <button type="button" class="nav-button">Profil</button>
    </a>
    <button type="button" class="nav-button">Déconnexion</button>
  </div>
  <div class="content" id="content-div">
    <!-- inserer details de la demande s'il y en a une, "aucune demande en cours sinon" -->
  </div>
</body>
<script>
  let nom_eleve = "";
  let prenom_eleve = "";

  function checkCurrentDemande() {
    $.ajax({
      url: "../ActionServlet",
      method: "POST",
      data: { todo: "current-demande" },
      dataType: "json",
    })
      .done(function (response) {
        const contentdiv = document.getElementById("content-div");
        if (response === null) {
          contentdiv.innerHTML = "<h1>Aucune demande de cours</h1>";
        } else {
          nom_eleve = response.eleve.nom;
          prenom_eleve = response.eleve.prenom;
          contentdiv.innerHTML = `<h1>Demande de cours</h1><div class='details'>
            <div class='left-column'><p><strong>Demande de cours :</strong></p>
              <p>Élève : ${' ' + nom_eleve + ' ' + prenom_eleve}</p>
              <p>Classe : ${' ' + response.eleve.classe}</p>
              <p>Établissement : ${' ' + response.eleve.etablissement}</p></div>
              <div class='right-column'>
              <p>Cours :</p>
              <p>Matière : ${' ' + response.matiere}</p>
              <p>Description : ${' ' + response.description}</p>
            </div>
            </div><button type='button' class='launch-button' onclick='launchVisio()'>Lancer Visio</button>`;
        }
      })
      .fail(function (error) {
        console.error("Erreur lors de la récupération de la demande:", error);
      });
  }

  function launchVisio() {
    $.ajax({
      url: "../ActionServlet",
      method: "POST",
      data: { todo: "start-video" },
      dataType: "json",
    })
      .done(function (response) {
        console.log("start video intervenat : ", response);
        const dialog = document.getElementById("visio-dialog");
        dialog.open = true;
      })
      .fail(function (error) {
        console.error("Erreur lors du lancement de la visio intervenant:", error);
      });
  }

  function endVisio() {
    const endButton = document.getElementById("end-visio-button");
    const sendButton = document.getElementById("send-button");
    const visioImg = document.getElementById("visio-img");
    visioImg.src = "../images/visio_off.png";
    sendButton.disabled = false;
    endButton.disabled = true;
    checkBilan();
  }

  function sendBilan() {
    const bilan = document.getElementById("bilan").value;
    $.ajax({
      url: "../ActionServlet",
      method: "POST",
      data: { todo: "send-bilan", bilan: bilan },
      dataType: "json",
    })
      .done(function (response) {
        console.log("send bilan : ", response);
        const dialog = document.getElementById("visio-dialog");
        dialog.open = false;
        checkCurrentDemande();
      })
      .fail(function (error) {
        console.error("Erreur lors de l'envoi du bilan:", error);
      });
  }

  function checkBilan() {
    const sendButton = document.getElementById("send-button");
    const bilan = document.getElementById("bilan").value;
    const endButton = document.getElementById("end-visio-button");
    sendButton.disabled = bilan.trim() === "" || !endButton.disabled;
  }

  document.addEventListener("DOMContentLoaded", function () {
    checkCurrentDemande();
  });
</script>

</html>
